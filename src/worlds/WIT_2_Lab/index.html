<html>
  <head>
    <meta charset="utf-8">

    <!-- Circles' head scripts [REQUIRED] -->
    <circles-start-scripts/>

    <!-- add your custom scripts here -->
    <!-- <script src="/worlds/hub/scripts/hub.js"></script> -->
    <script>
        AFRAME.registerComponent('narrative-soundmanager', {
          schema: {
          },

          init: function() {
            console.log("starting up narr man");
            const scene = document.querySelector('a-scene');

            const CONTEXT_AF = this;
            CONTEXT_AF.toolsNarr      = scene.querySelector('#Artefact-Drill');
            CONTEXT_AF.safetyNarr     = scene.querySelector('#Artefact-Gloves');
            CONTEXT_AF.cultureNarr    = scene.querySelector('#Artefact-Clipboard');

            CONTEXT_AF.toolsNarrFirstPlay = false;
            CONTEXT_AF.safetyNarrFirstPlay = false;
            CONTEXT_AF.cultureNarrFirstPlay = false;
            
            const player1 = document.querySelector('#Player1');
            const attachListenerFunc = () => {
              document.querySelectorAll('.narrative').forEach( entity => {
                console.log("adding sound listener");
                entity.addEventListener('click', (event) => {
                  if ( entity.getAttribute('id') == CONTEXT_AF.toolsNarr.getAttribute('id') ) {
                    if (CONTEXT_AF.toolsNarrFirstPlay === false) {
                      console.log('toolsNarrFirstPlay');
                      CONTEXT_AF.toolsNarr.components.sound.playSound();
                      CONTEXT_AF.toolsNarrFirstPlay = true;
                    }
                    else if (CONTEXT_AF.toolsNarr.components.sound.isPlaying === true) {
                      CONTEXT_AF.toolsNarr.components.sound.stopSound();
                      console.log("stopping toolsNarr");
                    }
                    else {
                      CONTEXT_AF.toolsNarr.components.sound.playSound();
                      console.log("playing toolsNarr");
                    }

                    if (CONTEXT_AF.safetyNarr.components.sound.isPlaying === true) {
                      CONTEXT_AF.safetyNarr.components.sound.stopSound();
                      console.log("stopping SafetyNarr");
                    }

                    if (CONTEXT_AF.cultureNarr.components.sound.isPlaying === true) {
                      CONTEXT_AF.cultureNarr.components.sound.stopSound();
                      console.log("stopping CultureNarr");
                    }
                  }
                  else if ( entity.getAttribute('id') == CONTEXT_AF.safetyNarr.getAttribute('id') ) {
                    if (CONTEXT_AF.toolsNarr.components.sound.isPlaying === true) {
                      CONTEXT_AF.toolsNarr.components.sound.stopSound();
                      console.log("stopping toolsNarr");
                    }

                    if (CONTEXT_AF.safetyNarrFirstPlay === false) {
                      console.log('safetyNarrFirstPlay');
                      CONTEXT_AF.safetyNarr.components.sound.playSound();
                      CONTEXT_AF.safetyNarrFirstPlay = true;
                    }
                    else if (CONTEXT_AF.safetyNarr.components.sound.isPlaying === true) {
                      CONTEXT_AF.safetyNarr.components.sound.stopSound();
                      console.log("stopping SafetyNarr");
                    }
                    else {
                      CONTEXT_AF.safetyNarr.components.sound.playSound();
                    }

                    if (CONTEXT_AF.cultureNarr.components.sound.isPlaying === true) {
                      CONTEXT_AF.cultureNarr.components.sound.stopSound();
                      console.log("stopping CultureNarr");
                    }
                  } 
                  else if ( entity.getAttribute('id') == CONTEXT_AF.cultureNarr.getAttribute('id') ) {
                    if (CONTEXT_AF.toolsNarr.components.sound.isPlaying === true) {
                      CONTEXT_AF.toolsNarr.components.sound.stopSound();
                      console.log("stopping toolsNarr");
                    }

                    if (CONTEXT_AF.safetyNarr.components.sound.isPlaying === true) {
                      CONTEXT_AF.safetyNarr.components.sound.stopSound();
                      console.log("stopping SafetyNarr");
                    }

                    if (CONTEXT_AF.cultureNarrFirstPlay === false) {
                      console.log('cultureNarrFirstPlay');
                      CONTEXT_AF.cultureNarr.components.sound.playSound();
                      CONTEXT_AF.cultureNarrFirstPlay = true;
                    }
                    else if (CONTEXT_AF.cultureNarr.components.sound.isPlaying === true) {
                      CONTEXT_AF.cultureNarr.components.sound.stopSound();
                      console.log("stopping CultureNarr");
                    }
                    else {
                      CONTEXT_AF.cultureNarr.components.sound.playSound();
                    }
                  }
                  else if ( entity.getAttribute('id') == 'release_control' ) {
                    //hacky ... I need to clean this up sometime to be a more general solution
                    CONTEXT_AF.toolsNarr.components.sound.stopSound();
                    CONTEXT_AF.safetyNarr.components.sound.stopSound();
                    CONTEXT_AF.cultureNarr.components.sound.stopSound();
                  }
                });
              });

              player1.removeEventListener(CIRCLES.EVENTS.CAMERA_ATTACHED, attachListenerFunc);
            };

            if (player1.querySelector('#release_control')) {
              attachListenerFunc();
            }
            else {
              player1.addEventListener(CIRCLES.EVENTS.CAMERA_ATTACHED, attachListenerFunc);
            }
          }
        });
    </script>
  </head>
  <body>

    <!-- a-scene with 'circles-properties' component [REQUIRED] -->
    <a-scene circles_properties>
      <a-assets timeout="10000">
        <!-- add your assets here -->

        <!-- audio -->

        <!-- narration -->
        <audio id="Narr_tools-snd" src="/worlds/WIT_2_Lab/assets/audio/Narr_Tools.ogg" preload="true"></audio>
        <audio id="Narr_safety-snd" src="/worlds/WIT_2_Lab/assets/audio/Narr_Safety.ogg" preload="true"></audio>
        <audio id="Narr_culture-snd" src="/worlds/WIT_2_Lab/assets/audio/Narr_Culture.ogg" preload="true"></audio>

        <!-- ambience -->
        <!-- 
          ATTRIBUTION:
          Amb_fan-snd: https://freesound.org/people/Gremsongs/sounds/130745/ 
          Amb_voices-snd: https://freesound.org/people/dobroide/sounds/35039/ 
          Amb_extractor-snd: https://freesound.org/people/zigzagzen/sounds/168073/
        -->
        <audio id="Amb_fan-snd" src="/worlds/WIT_2_Lab/assets/audio/Amb_Fan.ogg" preload="true"></audio>
        <audio id="Amb_voices-snd" src="/worlds/WIT_2_Lab/assets/audio/Amb_Voices.ogg" preload="true"></audio>
        <audio id="Amb_extractor-snd" src="/worlds/WIT_2_Lab/assets/audio/Amb_Extractor.ogg" preload="true"></audio>

        <!-- textures -->
        <img id='skyMap' src='/global/assets/textures/equirectangular/WhiteBlue.jpg' crossorigin="anonymous">

        <!-- physical environment -->
        <a-asset-item id="TestBench-gltf" response-type="arraybuffer" src="/worlds/WIT_2_Lab/assets/models/TestBenches/TestBenches.gltf"></a-asset-item>
        <a-asset-item id="Room-gltf" response-type="arraybuffer" src="/worlds/WIT_2_Lab/assets/models/Room/Room.gltf"></a-asset-item>
        <a-asset-item id="Table-gltf" response-type="arraybuffer" src="/worlds/WIT_2_Lab/assets/models/Table/Table.gltf"></a-asset-item>
        <a-asset-item id="TestWall-gltf" response-type="arraybuffer" src="/worlds/WIT_2_Lab/assets/models/TestWalls/TestWall_ALL.gltf"></a-asset-item>

        <!-- artefact models -->
        <a-asset-item id="Drill-gltf" src="/worlds/WIT_2_Lab/assets/models/Drill.glb" response-type="arraybuffer"></a-asset-item>
        <a-asset-item id="Gloves-gltf" src="/worlds/WIT_2_Lab/assets/models/Gloves.glb" response-type="arraybuffer"></a-asset-item>
        <a-asset-item id="Clipboard-gltf" src="/worlds/WIT_2_Lab/assets/models/Clipboard.glb" response-type="arraybuffer"></a-asset-item>

        <!-- Circles' built-in assets [REQUIRED] -->
        <circles-assets/>
      </a-assets>

      <!-- Circles' built-in avatar [REQUIRED] -->
      <circles-avatar/>

      <!-- checkpoints -->
      <a-entity circles-checkpoint circles-spawnpoint position="6.5 0.050 3.5"></a-entity>
      <a-entity circles-checkpoint circles-spawnpoint position="2.0 0.05 3.5"></a-entity>

      <a-entity circles-checkpoint circles-spawnpoint position="-2.8 0.05 4.1"></a-entity>
      <a-entity circles-checkpoint circles-spawnpoint position="-2.8 0.05 0.48"></a-entity>
      <a-entity circles-checkpoint circles-spawnpoint position="-2.8 0.05 -3.15"></a-entity>

      <a-entity circles-checkpoint circles-spawnpoint position="-1.4 0.05 2.3"></a-entity>
      <a-entity circles-checkpoint circles-spawnpoint position="-1.4 0.05 -1.32"></a-entity>

      <a-entity circles-checkpoint circles-spawnpoint position="2.0 0.05 1.0"></a-entity>
      <a-entity circles-checkpoint circles-spawnpoint position="2.0 0.05 -1.7"></a-entity>
      <a-entity circles-checkpoint circles-spawnpoint position="5.7 0.05 -1.7"></a-entity>
      <a-entity circles-checkpoint circles-spawnpoint position="5.7 0.05 1.0"></a-entity>

      <!-- sky and lights -->
      <a-entity light="type:ambient; color:#FFF; intensity:3.0" narrative-soundmanager></a-entity>

      <!-- sounds -->
      <a-entity position="7.5 1.0 4.7" circles-sound="type:ambient; src:#Amb_fan-snd; autoplay:true; loop:true; volume:0.1;" ></a-entity>
      <a-entity position="7.5 1.0 -4.7" circles-sound="type:ambient; src:#Amb_voices-snd; autoplay:true; loop:true; volume:0.1;" ></a-entity>
      <a-entity position="-4.3 2.3 -3.7" circles-sound="type:ambient; src:#Amb_extractor-snd; autoplay:true; loop:true; volume:0.4;" ></a-entity>

      <!-- environment / models -->
      <a-entity id="TestBench_model" gltf-model="#TestBench-gltf" circles-sphere-env-map="src:/global/assets/textures/equirectangular/WhiteBlue.jpg" postion="0 0 0" rotation="0 0 0" scale="0.01 0.01 0.01" shadow="receive:false; cast:false;"></a-entity>
      <a-entity id="TestWall_model" gltf-model="#TestWall-gltf" circles-sphere-env-map="src:/global/assets/textures/equirectangular/WhiteBlue.jpg" postion="0 0 0" rotation="0 0 0" scale="0.01 0.01 0.01" shadow="receive:false; cast:false;"></a-entity>
      <a-entity id="Room_Model" gltf-model="#Room-gltf" circles-sphere-env-map="src:/global/assets/textures/equirectangular/WhiteBlue.jpg" postion="0 0 0" rotation="0 0 0" scale="0.01 0.01 0.01" shadow="receive:false; cast:false;"></a-entity>
      <a-entity id="Table_Model" gltf-model="#Table-gltf" circles-sphere-env-map="src:/global/assets/textures/equirectangular/WhiteBlue.jpg" postion="0 0 0" rotation="0 0 0" scale="0.01 0.01 0.01" shadow="receive:false; cast:false;"></a-entity>

      <!-- artefacts -->
      <a-entity id="Artefact-Drill"
                position="4 0.95 0" rotation="0 30 0" scale="0.01 0.01 0.01"
                gltf-model="#Drill-gltf" 
                shadow="receive:false; cast:false;"
                circles-sphere-env-map="src:/global/assets/textures/equirectangular/WhiteBlue.jpg"
                circles-artefact="inspectScale:0.02 0.02 0.02; textRotationY:0; textLookAt:false; inspectRotation:0 90 0;
                                  label_visible:true; label_offset:0 0.5 0; arrow_position:down;
                                  title:Group Work; 
                                  description:Men usually go into trades with a better understanding of tools such as this drill. However, women may not have had the same exposure. Though with positive intentions men taking over exercises with unfamiliar tools prevents women from learning.;
                                  label_text:Power Drill;
                                  audio:#Narr_tools-snd; volume:0.4;"></a-entity>

      <a-entity id="Artefact-Gloves"
                class="interactive narrative"
                position="-4.2 0.83 4.3" rotation="-90 -50 0" scale="0.015 0.015 0.015"
                gltf-model="#Gloves-gltf" 
                shadow="receive:false; cast:false;"
                circles-sphere-env-map="src:/global/assets/textures/equirectangular/WhiteBlue.jpg"
                circles-artefact="inspectScale:0.05 0.05 0.05; textRotationY:90; textLookAt:false; inspectRotation:0 0 0;
                                  label_visible:true; label_offset:0 0.5 0; arrow_position:down;
                                  title:Equipment; 
                                  description:To save on costs and space, schools tend to purchase generic sizes for safety and protective wear. Large sizes are common. Women often must compensate by making adjustments or risking safety and fine motor skills by wearing ill-fitting attire.;
                                  label_text:Safety Gloves;
                                  audio:#Narr_safety-snd; volume:0.4;"></a-entity>

      <a-entity id="Artefact-Clipboard"
                class="interactive narrative"
                position="0.65 0.79 1.61" rotation="-90 15 0.0" scale="0.015 0.015 0.015"
                gltf-model="#Clipboard-gltf" 
                shadow="receive:false; cast:false;"
                circles-sphere-env-map="src:/global/assets/textures/equirectangular/WhiteBlue.jpg"
                circles-artefact="inspectScale:0.03 0.03 0.03; textRotationY:90; textLookAt:false; inspectRotation:0 0 0;
                                  label_visible:true; label_offset:0 0.5 0; arrow_position:down;
                                  title:Culture; 
                                  description:As the professor walks around taking attendance, women notice he talks more with the men. Without knowing, the teacher is adding another layer of insecurity by assuming the women wouldn't have anything to interesting to talk about.;
                                  label_text:Clipboard;
                                  audio:#Narr_culture-snd; volume:0.4;"></a-entity>
    </a-scene>

    <!-- Circles' end scripts [REQUIRED] -->
    <circles-end-scripts/>
  </body>
</html>
